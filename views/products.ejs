<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T·∫•t c·∫£ s·∫£n ph·∫©m | Fashion Shop</title>
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/home.css">
  <link rel="stylesheet" href="/assets/css/footer.css">
  <link rel="stylesheet" href="/assets/css/products.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
  <%- include('partials/header') %>

    <!-- BREADCRUMB -->
    <div class="breadcrumb">
      <a href="/home">Trang ch·ªß</a>
      <span>‚Ä∫</span>
      <span class="current">T·∫•t c·∫£ s·∫£n ph·∫©m</span>
    </div>

    <section class="categories">
      <div class="categories-list">
        <div class="category-item">
          <a href="menshirt">
            <img src="/assets/img/menshirt.jpg">
            <h3>√Åo nam</h3>
          </a>
        </div>

        <div class="category-item">
          <a href="menpants">
            <img src="/assets/img/menpants.jpg">
            <h3>Qu·∫ßn nam</h3>
          </a>
        </div>

        <div class="category-item">
          <a href="menaccessories">
            <img src="/assets/img/men accessories .jpg">
            <h3>Ph·ª• ki·ªán nam</h3>
          </a>
        </div>

        <div class="category-item">
          <a href="womenshirt">
            <img src="/assets/img/women's shirt.jpg">
            <h3>√Åo n·ªØ</h3>
          </a>
        </div>

        <div class="category-item">
          <a href="womenpants">
            <img src="/assets/img/women's pants.jpg">
            <h3>Qu·∫ßn n·ªØ</h3>
          </a>
        </div>

        <div class="category-item">
          <a href="womenaccessories">
            <img src="/assets/img/phukien.jpg">
            <h3>Ph·ª• ki·ªán n·ªØ</h3>
          </a>
        </div>
      </div>
    </section>

    <!-- ========== LAYOUT 2 C·ªòT ========== -->
    <div class="products-container">
      <div class="filter-sidebar">
        <h3 class="filter-title">B·ªô l·ªçc s·∫£n ph·∫©m</h3>

        <!-- Th∆∞∆°ng hi·ªáu -->
        <div class="filter-group">
          <h4>Th∆∞∆°ng hi·ªáu</h4>
          <label><input type="checkbox" class="filter-brand" value="Nike" onchange="applyFilters()"> Nike</label>
          <label><input type="checkbox" class="filter-brand" value="Adidas" onchange="applyFilters()"> Adidas</label>
          <label><input type="checkbox" class="filter-brand" value="Gucci" onchange="applyFilters()"> Gucci</label>
          <label><input type="checkbox" class="filter-brand" value="LV" onchange="applyFilters()"> LV</label>
        </div>

        <!-- Lo·∫°i s·∫£n ph·∫©m -->
        <div class="filter-group">
          <h4>Lo·∫°i s·∫£n ph·∫©m</h4>
          <label><input type="checkbox" class="filter-category" value="√Åo" onchange="applyFilters()"> √Åo</label>
          <label><input type="checkbox" class="filter-category" value="Qu·∫ßn" onchange="applyFilters()"> Qu·∫ßn</label>
          <label><input type="checkbox" class="filter-category" value="Ph·ª• ki·ªán" onchange="applyFilters()"> Ph·ª•
            ki·ªán</label>
        </div>

        <!-- Gi√° -->
        <div class="filter-group">
          <h4>Gi√°</h4>
          <label><input type="checkbox" class="filter-price" value="0-200000" onchange="applyFilters()"> D∆∞·ªõi
            200k</label>
          <label><input type="checkbox" class="filter-price" value="200000-500000" onchange="applyFilters()"> 200k ‚Äì
            500k</label>
          <label><input type="checkbox" class="filter-price" value="500000-1000000" onchange="applyFilters()"> 500k ‚Äì 1
            tri·ªáu</label>
          <label><input type="checkbox" class="filter-price" value="1000000-999999999" onchange="applyFilters()"> Tr√™n 1
            tri·ªáu</label>
        </div>
      </div>

      <div class="products-content">
        <!-- PH·∫¶N S·∫ÆP X·∫æP -->
        <div class="sort-section">
          <h3 class="sort-title">T·∫•t c·∫£ s·∫£n ph·∫©m</h3>
          <div class="sort-dropdown">
            <button class="sort-button">
              S·∫Øp x·∫øp theo
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="sort-options">
              <div class="sort-option active">M·∫∑c ƒë·ªãnh</div>
              <div class="sort-option">A ‚Äì Z</div>
              <div class="sort-option">Z ‚Äì A</div>
              <div class="sort-option">Gi√° tƒÉng d·∫ßn</div>
              <div class="sort-option">Gi√° gi·∫£m d·∫ßn</div>
            </div>
          </div>
        </div>

        <div class="product-list">
          <% products.forEach(p=> { %>
            <div class="product-card" data-price="<%= p.Price %>" data-category-id="<%= p.CategoryID %>"
              data-name="<%= p.ProductName.toLowerCase() %>">
              <a href="/product/<%= p.ProductID %>" class="product-link">
                <div class="product-img">
                  <img src="<%= p.Image %>" alt="<%= p.ProductName %>">
                </div>
                <div class="product-info">
                  <h4 class="product-name">
                    <%= p.ProductName %>
                  </h4>
                  <p class="product-price">
                    <%= p.Price.toLocaleString() %>ƒë
                  </p>
                </div>
              </a>

              <div class="product-actions">
                <button class="btn-wishlist"><i class="fa-regular fa-heart"></i></button>
                <button class="btn-add-cart" data-id="<%= p.ProductID %>" data-name="<%= p.ProductName %>"
                  data-price="<%= p.Price %>" data-image="<%= p.Image %>">
                  <i class="fa-solid fa-cart-shopping"></i>
                </button>
              </div>
            </div>
            <% }) %>
        </div>
      </div>
    </div>

    <%- include('partials/footer') %>

      <script>
        // ========== SORT DROPDOWN FUNCTIONALITY ==========
        const sortButton = document.querySelector('.sort-button');
        const sortOptions = document.querySelector('.sort-options');
        const sortOptionItems = document.querySelectorAll('.sort-option');
        const productList = document.querySelector('.product-list');

        // Toggle dropdown
        sortButton.addEventListener('click', function (e) {
          e.stopPropagation();
          sortOptions.classList.toggle('show');
          sortButton.classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
          if (!e.target.closest('.sort-dropdown')) {
            sortOptions.classList.remove('show');
            sortButton.classList.remove('active');
          }
        });

        // Handle sort option selection
        sortOptionItems.forEach(option => {
          option.addEventListener('click', function () {
            // Remove active class from all options
            sortOptionItems.forEach(opt => opt.classList.remove('active'));

            // Add active class to selected option
            this.classList.add('active');

            // Update button text
            sortButton.childNodes[0].textContent = this.textContent + ' ';

            // Close dropdown
            sortOptions.classList.remove('show');
            sortButton.classList.remove('active');

            // Sort products
            sortProducts(this.textContent.trim());
          });
        });

        function sortProducts(sortType) {
          const products = Array.from(productList.querySelectorAll('.product-card'));

          products.sort((a, b) => {
            const nameA = a.querySelector('.product-name').textContent.trim();
            const nameB = b.querySelector('.product-name').textContent.trim();
            const priceA = parseInt(a.querySelector('.product-price').textContent.replace(/[^\d]/g, ''));
            const priceB = parseInt(b.querySelector('.product-price').textContent.replace(/[^\d]/g, ''));

            switch (sortType) {
              case 'A ‚Äì Z':
                return nameA.localeCompare(nameB, 'vi');
              case 'Z ‚Äì A':
                return nameB.localeCompare(nameA, 'vi');
              case 'Gi√° tƒÉng d·∫ßn':
                return priceA - priceB;
              case 'Gi√° gi·∫£m d·∫ßn':
                return priceB - priceA;
              default: // M·∫∑c ƒë·ªãnh
                return 0;
            }
          });

          // Re-append sorted products
          products.forEach(product => productList.appendChild(product));
        }

        // ========== FILTER FUNCTIONALITY ==========
        function applyFilters() {
          const brandFilters = Array.from(document.querySelectorAll('.filter-brand:checked')).map(cb => cb.value);
          const categoryFilters = Array.from(document.querySelectorAll('.filter-category:checked')).map(cb => cb.value);
          const priceFilters = Array.from(document.querySelectorAll('.filter-price:checked')).map(cb => cb.value);

          const productCards = document.querySelectorAll('.product-card');

          productCards.forEach(card => {
            let showCard = true;

            // Filter by brand (check if product name contains brand)
            if (brandFilters.length > 0) {
              const productName = card.getAttribute('data-name');
              const hasBrand = brandFilters.some(brand => productName.includes(brand.toLowerCase()));
              if (!hasBrand) showCard = false;
            }

            // Filter by category (CategoryID: 1=√Åo nam, 2=Qu·∫ßn nam, 3=Ph·ª• ki·ªán nam, 4=√Åo n·ªØ, 5=Qu·∫ßn n·ªØ, 6=Ph·ª• ki·ªán n·ªØ)
            if (categoryFilters.length > 0) {
              const categoryId = parseInt(card.getAttribute('data-category-id'));
              let matchCategory = false;

              categoryFilters.forEach(cat => {
                if (cat === '√Åo' && (categoryId === 1 || categoryId === 4)) matchCategory = true;
                if (cat === 'Qu·∫ßn' && (categoryId === 2 || categoryId === 5)) matchCategory = true;
                if (cat === 'Ph·ª• ki·ªán' && (categoryId === 3 || categoryId === 6)) matchCategory = true;
              });

              if (!matchCategory) showCard = false;
            }

            // Filter by price
            if (priceFilters.length > 0) {
              const price = parseInt(card.getAttribute('data-price'));
              let matchPrice = false;

              priceFilters.forEach(range => {
                const [min, max] = range.split('-').map(Number);
                if (price >= min && price <= max) matchPrice = true;
              });

              if (!matchPrice) showCard = false;
            }

            // Show/hide card
            card.style.display = showCard ? '' : 'none';
          });
        }

        // ========== ADD TO CART FUNCTIONALITY ==========

        // Th√™m s·ª± ki·ªán cho n√∫t th√™m v√†o gi·ªè h√†ng
        document.querySelectorAll('.btn-add-cart').forEach(button => {
          button.addEventListener('click', async function (e) {
            e.preventDefault();
            e.stopPropagation();

            // üî• FIX: L·∫•y th√¥ng tin s·∫£n ph·∫©m v√† variant m·∫∑c ƒë·ªãnh
            const productId = parseInt(this.getAttribute('data-id'));

            // G·ªçi API ƒë·ªÉ l·∫•y variant m·∫∑c ƒë·ªãnh (m√†u ƒëen, size S)
            try {
              const response = await fetch(`/api/product/${productId}/default-variant`);
              const variantData = await response.json();

              const product = {
                id: productId,
                name: this.getAttribute('data-name'),
                price: parseInt(this.getAttribute('data-price')),
                image: this.getAttribute('data-image'),
                variantId: variantData.variantId || null,
                color: variantData.color || 'ƒêen', // M·∫∑c ƒë·ªãnh m√†u ƒëen
                size: variantData.size || 'S',     // M·∫∑c ƒë·ªãnh size S
                quantity: 1
              };

              if (window.addToCart) {
                const success = await window.addToCart(product);
                if (success) {
                  // Hi·ªáu ·ª©ng th√¥ng b√°o
                  this.innerHTML = '<i class="fa-solid fa-check"></i>';
                  this.style.background = '#28a745';
                  setTimeout(() => {
                    this.innerHTML = '<i class="fa-solid fa-cart-shopping"></i>';
                    this.style.background = '';
                  }, 1000);
                }
              }
            } catch (error) {
              console.error('L·ªói khi l·∫•y variant:', error);
              // Fallback: th√™m kh√¥ng c√≥ variant
              const product = {
                id: productId,
                name: this.getAttribute('data-name'),
                price: parseInt(this.getAttribute('data-price')),
                image: this.getAttribute('data-image'),
                variantId: null,
                color: 'ƒêen',
                size: 'S',
                quantity: 1
              };
              window.addToCart(product);
            }
          });
        });

      </script>
</body>

</html>