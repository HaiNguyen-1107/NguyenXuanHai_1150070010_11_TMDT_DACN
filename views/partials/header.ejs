<header>
  <div class="header-top">
    <div class="logo">Fashion Shop</div>

    <div class="search">
      <div class="search-wrapper">
        <input type="text" id="headerSearchInput" placeholder="T√¨m ki·∫øm..." class="search-input"
          oninput="headerSearch()" onfocus="showHeaderSearchDropdown()" onblur="hideHeaderSearchDropdown()">
        <i class="fas fa-search search-icon-inside"></i>
        <div id="headerSearchDropdown" class="header-search-dropdown"></div>
      </div>
    </div>

    <div class="header-icons">
      <% if (user) { %>
        <a href="/profile" class="icon-box" id="accountButton">
          <i class="fa-regular fa-user"></i>
          <span>
            <%= user.Username %>
          </span>
        </a>
        <% } else { %>
          <a href="javascript:void(0)" class="icon-box" id="accountButton">
            <i class="fa-regular fa-user"></i>
            <span>T√†i kho·∫£n</span>
          </a>
          <% } %>

            <a href="javascript:void(0)" class="icon-box" id="cartButton">
              <i class="fa-solid fa-bag-shopping"></i>
              <span>Gi·ªè h√†ng</span>
              <span class="cart-count" id="cartCount">0</span>
            </a>
    </div>
  </div>

  <nav>
    <ul>
      <li><a href="/home">Trang ch·ªß</a></li>
      <li><a href="/products">T·∫•t c·∫£ s·∫£n ph·∫©m</a></li>
      <li><a href="/about">Gi·ªõi thi·ªáu</a></li>
      <li><a href="/news">Tin t·ª©c</a></li>
      <li><a href="/contact">Li√™n h·ªá</a></li>
    </ul>
  </nav>
</header>

<!-- OVERLAY -->
<div id="sidebarOverlay" class="sidebar-overlay"></div>

<!-- SIDEBAR GI·ªé H√ÄNG -->
<div id="sidebar" class="sidebar">
  <div class="sidebar-header">
    <h2 id="sidebarTitle">Gi·ªè h√†ng</h2>
    <button id="closeSidebar" class="close-sidebar">√ó</button>
  </div>

  <div id="cartContent">
    <!-- N·ªôi dung gi·ªè h√†ng s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JavaScript -->
  </div>
</div>

<!-- LOGIN MODAL -->
<div id="loginModal" class="modal-login">
  <div class="modal-login-container">

    <!-- Left illustration -->
    <div class="modal-illustration">
      <img src="/assets/img/login-illustration.png" alt="Login Illustration">
      <h2>Xin ch√†o!</h2>
      <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c mua s·∫Øm</p>
    </div>

    <!-- Right form -->
    <div class="modal-form-area">

      <!-- Close button -->
      <button class="login-close-btn" id="closeLogin"></button>

      <!-- Tabs -->
      <div class="login-tabs">
        <button class="tab-btn active" id="tabLogin">ƒêƒÉng nh·∫≠p</button>
        <button class="tab-btn" id="tabRegister">ƒêƒÉng k√Ω</button>
      </div>

      <!-- Login Form -->
      <form id="loginForm" class="form active" method="POST" action="/login">
        <div class="input-group">
          <label>Email</label>
          <input type="email" name="email" placeholder="Nh·∫≠p email..." required>
        </div>

        <div class="input-group">
          <label>M·∫≠t kh·∫©u</label>
          <div class="password-wrap">
            <input type="password" name="password" id="loginPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." required>
            <i class="fa-solid fa-eye-slash toggle-pass" onclick="togglePassword('loginPass', this)"></i>
          </div>
        </div>

        <button type="submit" class="btn-submit">ƒêƒÉng nh·∫≠p</button>

        <p class="helper-text">
          B·∫°n ch∆∞a c√≥ t√†i kho·∫£n? <span class="switch-link" onclick="switchToRegister()">ƒêƒÉng k√Ω ngay</span>
        </p>
      </form>

      <!-- Register Form -->
      <form id="registerForm" class="form" method="POST" action="/register">
        <div class="input-group">
          <label>T√™n ƒëƒÉng nh·∫≠p</label>
          <input type="text" name="username" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p..." required>
        </div>

        <div class="input-group">
          <label>Email</label>
          <input type="email" name="email" placeholder="Nh·∫≠p email..." required>
        </div>

        <div class="input-group">
          <label>M·∫≠t kh·∫©u</label>
          <div class="password-wrap">
            <input type="password" name="password" id="regPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." required>
            <i class="fa-solid fa-eye-slash toggle-pass" onclick="togglePassword('regPass', this)"></i>
          </div>
        </div>

        <div class="input-group">
          <label>Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label>
          <div class="password-wrap">
            <input type="password" name="confirm" id="regConfirm" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u..." required>
            <i class="fa-solid fa-eye-slash toggle-pass" onclick="togglePassword('regConfirm', this)"></i>
          </div>
        </div>

        <!-- Hidden role field - m·∫∑c ƒë·ªãnh User -->
        <input type="hidden" name="role" value="User">

        <button type="submit" class="btn-submit">ƒêƒÉng k√Ω</button>
      </form>

    </div>

  </div>
</div>


<script>
  window.isLoggedIn = <%= user ? true : false %>;
  window.currentUserId = <%= user ? user.UserID : 'null' %>;
</script>

<script>

  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("sidebarOverlay");
  const closeSidebar = document.getElementById("closeSidebar");
  const cartBtn = document.getElementById("cartButton");
  const cartCount = document.getElementById("cartCount");
  const cartContent = document.getElementById("cartContent");

  //  FIX: L·∫•y gi·ªè h√†ng t·ª´ localStorage v·ªõi validation
  function getCart() {
    try {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];

      // Validate v√† chu·∫©n h√≥a d·ªØ li·ªáu
      cart = cart.map(item => ({
        id: parseInt(item.id) || 0,
        name: item.name || 'S·∫£n ph·∫©m',
        price: Number(item.price ?? item.Price ?? 0),
        image: item.image || '/assets/img/default-product.jpg',
        color: item.color || '',
        size: item.size || '',
        variantId: (item.variantId && item.variantId !== 0 && item.variantId !== 'null') ? item.variantId : null,
        quantity: parseInt(item.quantity) || 1
      })).filter(item => item.id > 0 && item.quantity > 0); // Lo·∫°i b·ªè item kh√¥ng h·ª£p l·ªá

      return cart;
    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y gi·ªè h√†ng:', error);
      return [];
    }
  }

  // L∆∞u gi·ªè h√†ng v√†o localStorage
  function saveCart(cart) {
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  //C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng
  function updateCartCount() {
    const cart = getCart();
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = totalItems;
  }

  // L·∫•y UserID 
  function getCurrentUserId() {
    return window.currentUserId;
  }

  // API call ƒë·ªÉ l∆∞u gi·ªè h√†ng l√™n server
  async function saveCartToServer(cart) {
    try {
      const userId = getCurrentUserId();
      if (!userId) return;

      const response = await fetch('/api/cart/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: cart, userId: userId })
      });

      const result = await response.json();
      if (result.success) {
        console.log(' ƒê√£ l∆∞u gi·ªè h√†ng v√†o database');
      }
    } catch (error) {
      console.error(' L·ªói khi l∆∞u gi·ªè h√†ng:', error);
    }
  }

  // API call ƒë·ªÉ x√≥a item kh·ªèi gi·ªè h√†ng tr√™n server
  async function removeFromCartOnServer(productId, variantId) {
    try {
      const userId = getCurrentUserId();
      if (!userId) return;

      const response = await fetch('/api/cart/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          productId: parseInt(productId),
          variantId: (variantId && variantId !== 0) ? variantId : null,
          userId: userId
        })
      });

      const result = await response.json();
      if (result.success) {
        console.log("ƒê√£ x√≥a trong DB");
      }
    } catch (err) {
      console.error("L·ªói x√≥a:", err);
    }
  }

  // API call ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng tr√™n server
  async function updateQuantityOnServer(productId, variantId, quantity) {
    try {
      const userId = getCurrentUserId();
      if (!userId) return;

      const response = await fetch('/api/cart/update-quantity', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          productId: parseInt(productId),
          variantId: (variantId && variantId !== 0) ? variantId : null,
          quantity: parseInt(quantity),
          userId: userId
        })
      });

      const result = await response.json();
      if (result.success) {
        console.log("C·∫≠p nh·∫≠t DB th√†nh c√¥ng");
      }
    } catch (err) {
      console.error("L·ªói update:", err);
    }
  }

  //  FIX: Hi·ªÉn th·ªã gi·ªè h√†ng trong sidebar
  function renderCart() {
    const cart = getCart();
    console.log('üõí Rendering cart:', cart);

    if (cart.length === 0) {
      cartContent.innerHTML = `
      <div class="sidebar-empty">
        <i class="fas fa-shopping-cart" style="font-size: 80px; color: #ddd; margin-bottom: 20px;"></i>
        <h3>Gi·ªè h√†ng ch∆∞a c√≥ g√¨!</h3>
        <p>H√£y t√¨m s·∫£n ph·∫©m ∆∞ng √Ω v√† th√™m v√†o gi·ªè h√†ng b·∫°n nh√©</p>
        <a href="/products" class="btn-continue">Ti·∫øp t·ª•c mua s·∫Øm</a>
      </div>
    `;
    } else {
      let subtotal = 0;
      let cartHTML = `
      <div class="cart-items">
    `;

      cart.forEach(item => {
        const itemId = parseInt(item.id) || 0;
        const itemVariantId = (item.variantId && item.variantId !== 0) ? item.variantId : null;
        const itemPrice = Number(item.price ?? item.Price ?? 0);
        const itemQuantity = parseInt(item.quantity) || 1;
        const itemTotal = itemPrice * itemQuantity;
        subtotal += itemTotal;

        const itemName = item.name || 'S·∫£n ph·∫©m';
        const itemImage = item.image || '/assets/img/default-product.jpg';
        const itemColor = item.color || '';
        const itemSize = item.size || '';

        cartHTML += `
        <div class="cart-item" data-product-id="${itemId}" data-variant-id="${itemVariantId}">
          <div class="cart-item-image">
            <img src="${itemImage}" alt="${itemName}" onerror="this.src='/assets/img/default-product.jpg'">
          </div>
          <div class="cart-item-details">
            <h4 class="cart-item-name">${itemName}</h4>
            ${itemColor ? `<p class="cart-item-variant">M√†u: ${itemColor}</p>` : ''}
            ${itemSize ? `<p class="cart-item-variant">Size: ${itemSize}</p>` : ''}
            <p class="cart-item-price">${itemPrice.toLocaleString()}ƒë</p>
            <div class="cart-item-quantity">
              <button class="quantity-btn minus" data-id="${itemId}" data-variant-id="${itemVariantId}">-</button>
              <span class="quantity">${itemQuantity}</span>
              <button class="quantity-btn plus" data-id="${itemId}" data-variant-id="${itemVariantId}">+</button>
            </div>
          </div>
          <button class="remove-item" data-id="${itemId}" data-variant-id="${itemVariantId}">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      });

      cartHTML += `</div>`;
      cartHTML += `
      <div class="cart-summary">
        <div class="cart-total">
          <span>T·∫°m t√≠nh:</span>
          <span>${subtotal.toLocaleString()}ƒë</span>
        </div>
        <div class="cart-actions">
          <button class="btn-checkout" onclick="proceedToCheckout()">Thanh to√°n</button>
        </div>
      </div>
    `;

      cartContent.innerHTML = cartHTML;

      // Th√™m s·ª± ki·ªán cho c√°c n√∫t
      document.querySelectorAll('.quantity-btn.plus').forEach(btn => {
        btn.addEventListener('click', function () {
          const productId = parseInt(this.getAttribute('data-id'));
          const variantId = this.getAttribute('data-variant-id');
          const safeVariantId = (variantId === "null" || variantId === "undefined" || variantId === null)
            ? null
            : parseInt(variantId);
          updateQuantity(productId, safeVariantId, 1);
        });
      });

      document.querySelectorAll('.quantity-btn.minus').forEach(btn => {
        btn.addEventListener('click', function () {
          const productId = parseInt(this.getAttribute('data-id'));
          const variantId = this.getAttribute('data-variant-id');
          const safeVariantId = (variantId === "null" || variantId === "undefined" || variantId === null)
            ? null
            : parseInt(variantId);
          updateQuantity(productId, safeVariantId, -1);
        });
      });

      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', function () {
          const productId = parseInt(this.getAttribute('data-id'));
          const variantId = this.getAttribute('data-variant-id');
          const safeVariantId = (variantId === "null" || variantId === "undefined" || variantId === null)
            ? null
            : parseInt(variantId);
          removeFromCart(productId, safeVariantId);
        });
      });
    }
  }

  // Th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng
  async function addToCart(product) {
    if (!window.isLoggedIn) {
      sidebar.classList.remove("active");
      overlay.classList.remove("active");
      document.getElementById("loginModal").style.display = "flex";
      return false;
    }

    try {
      const response = await fetch('/api/cart/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          productId: product.id,
          variantId: product.variantId,
          quantity: product.quantity || 1,
          userId: window.currentUserId
        })
      });

      const result = await response.json();

      if (result.success) {
        const cart = getCart();
        const productVariantId = (product.variantId && product.variantId !== 0) ? product.variantId : null;

        const existingItem = cart.find(
          item => item.id === product.id &&
            ((item.variantId ?? null) === (productVariantId ?? null) ||
              (item.variantId === null && productVariantId === null))
        );

        if (existingItem) {
          existingItem.quantity += product.quantity || 1;
        } else {
          cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            image: product.image,
            color: product.color || '',
            size: product.size || '',
            variantId: productVariantId,
            quantity: product.quantity || 1
          });
        }

        saveCart(cart);
        updateCartCount();
        renderCart();
        openSidebar();

        return true;
      } else {
        alert('L·ªói khi th√™m v√†o gi·ªè h√†ng: ' + result.message);
        return false;
      }
    } catch (error) {
      console.error('‚ùå L·ªói khi th√™m v√†o gi·ªè h√†ng:', error);
      alert('L·ªói k·∫øt n·ªëi server');
      return false;
    }
  }

  // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
  function updateQuantity(productId, variantId, change) {
    productId = parseInt(productId);
    const cart = getCart();

    const item = cart.find(item =>
      item.id === productId &&
      (item.variantId ?? null) === (variantId ?? null)
    );

    if (item) {
      item.quantity += change;

      if (item.quantity <= 0) {
        removeFromCart(productId, variantId);
      } else {
        saveCart(cart);
        updateCartCount();
        renderCart();
        updateQuantityOnServer(item.id, item.variantId, item.quantity);
      }
    } else {
      console.error(' Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m trong gi·ªè:', productId, variantId);
    }
  }

  // X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng
  function removeFromCart(productId, variantId) {
    productId = parseInt(productId);
    let cart = getCart();

    const item = cart.find(item =>
      item.id === productId &&
      (item.variantId ?? null) === (variantId ?? null)
    );

    if (item) {
      cart = cart.filter(cartItem =>
        !(
          cartItem.id === productId &&
          (cartItem.variantId ?? null) === (variantId ?? null)
        )
      );

      saveCart(cart);
      updateCartCount();
      renderCart();
      removeFromCartOnServer(item.id, item.variantId);
    }
  }

  // M·ªü sidebar
  function openSidebar() {
    sidebar.classList.add("active");
    overlay.classList.add("active");
    renderCart();
  }

  // ƒê√≥ng sidebar
  function closeSidebarFunc() {
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
  }

  // S·ª± ki·ªán
  cartBtn.onclick = openSidebar;
  closeSidebar.onclick = closeSidebarFunc;
  overlay.onclick = closeSidebarFunc;

  // Load gi·ªè h√†ng t·ª´ server
  async function loadCartFromServer() {
    if (!window.isLoggedIn) return;

    try {
      const response = await fetch(`/api/cart/load?userId=${window.currentUserId}`);
      const result = await response.json();

      console.log('üîÑ Load cart from server:', result);

      if (result.success && result.items && Array.isArray(result.items)) {
        const validItems = result.items.map(item => {
          console.log(' Processing item from server:', item);
          return {
            id: parseInt(item.id) || 0,
            name: item.name || '',
            price: Number(item.price ?? item.Price ?? 0),
            image: item.image || '',
            color: item.color || '',
            size: item.size || '',
            variantId: (item.variantId && item.variantId !== 0) ? item.variantId : null,
            quantity: parseInt(item.quantity) || 1
          };
        }).filter(i => i.id > 0);

        console.log(' Valid cart items:', validItems);
        localStorage.setItem("cart", JSON.stringify(validItems));
        return validItems;
      } else {
        console.log(' No items in cart or load failed');
        localStorage.setItem("cart", JSON.stringify([]));
        return [];
      }
    } catch (err) {
      console.error(" Load cart error:", err);
      return [];
    }
  }

  // ƒê·ªìng b·ªô gi·ªè h√†ng khi ƒëƒÉng nh·∫≠p
  async function syncCartOnLogin() {
    if (!window.isLoggedIn) return;

    try {
      console.log(" B·∫Øt ƒë·∫ßu ƒë·ªìng b·ªô gi·ªè h√†ng...");

      const serverCart = await loadCartFromServer();
      const localCart = getCart();

      if (localCart.length > 0 && serverCart.length === 0) {
        console.log(" Merge local cart l√™n server...");
        const response = await fetch("/api/cart/merge", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            localItems: localCart,
            userId: window.currentUserId
          })
        });

        const result = await response.json();
        if (result.success) {
          console.log(" Merge th√†nh c√¥ng!");
          await loadCartFromServer();
        }
      } else if (serverCart.length > 0) {
        console.log(" S·ª≠ d·ª•ng gi·ªè h√†ng t·ª´ server");
      }

      console.log(" ƒê·ªìng b·ªô gi·ªè h√†ng ho√†n t·∫•t");
    } catch (e) {
      console.error(" Sync cart error:", e);
    }
  }

  // Kh·ªüi t·∫°o
  async function initCart() {
    if (window.isLoggedIn) {
      console.log(" User ƒë√£ ƒëƒÉng nh·∫≠p - ƒë·ªìng b·ªô gi·ªè h√†ng...");
      await syncCartOnLogin();
      updateCartCount();
      renderCart();
    } else {
      console.log(" User ch∆∞a ƒëƒÉng nh·∫≠p - ch·ªâ d√πng local cart");
      updateCartCount();
      renderCart();
    }
  }

  initCart();

  // Cho ph√©p c√°c file kh√°c s·ª≠ d·ª•ng h√†m addToCart
  window.addToCart = addToCart;

  // OPEN MODAL 
  document.getElementById("accountButton")?.addEventListener("click", () => {
    if (!window.isLoggedIn) {
      sidebar.classList.remove("active");
      overlay.classList.remove("active");
      document.getElementById("loginModal").style.display = "flex";
    }
  });

  // CLOSE
  document.getElementById("closeLogin").onclick = () => {
    document.getElementById("loginModal").style.display = "none";
  };

  // CLICK OUTSIDE CLOSE
  window.onclick = (e) => {
    if (e.target.id === "loginModal") {
      document.getElementById("loginModal").style.display = "none";
    }
  };

  // TAB SWITCH
  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");

  tabLogin.onclick = () => {
    tabLogin.classList.add("active");
    tabRegister.classList.remove("active");
    loginForm.classList.add("active");
    registerForm.classList.remove("active");
  };

  tabRegister.onclick = () => {
    tabRegister.classList.add("active");
    tabLogin.classList.remove("active");
    registerForm.classList.add("active");
    loginForm.classList.remove("active");
  };

  document.getElementById("loginForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    let formData = new FormData(e.target);
    let data = Object.fromEntries(formData.entries());
    let result = await fetch("/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    }).then(res => res.json());
    if (result.success) {
      location.reload();
    } else {
      // Toast notification ·ªü g√≥c d∆∞·ªõi b√™n ph·∫£i
      const Toast = Swal.mixin({
        toast: true,
        position: 'bottom-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.addEventListener('mouseenter', Swal.stopTimer)
          toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
      });

      Toast.fire({
        icon: 'error',
        title: result.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!'
      });
    }
  });

  // X·ª≠ l√Ω form ƒëƒÉng k√Ω
  document.getElementById("registerForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    let formData = new FormData(e.target);
    let data = Object.fromEntries(formData.entries());

    let result = await fetch("/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    }).then(res => res.json());

    // Toast notification ·ªü g√≥c d∆∞·ªõi b√™n ph·∫£i
    const Toast = Swal.mixin({
      toast: true,
      position: 'bottom-end',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
      }
    });

    if (result.success) {
      Toast.fire({
        icon: 'success',
        title: 'ƒêƒÉng k√Ω th√†nh c√¥ng!'
      });
      // Chuy·ªÉn sang tab ƒëƒÉng nh·∫≠p sau 1.5s
      setTimeout(() => {
        document.getElementById("tabLogin").click();
        e.target.reset();
      }, 1500);
    } else {
      Toast.fire({
        icon: 'error',
        title: result.message || 'ƒêƒÉng k√Ω th·∫•t b·∫°i!'
      });
    }
  });

  // Khi logout ‚Üí reset flag
  function logout() {
    localStorage.removeItem("cart");
    localStorage.removeItem("cartSynced");
    window.location.href = "/logout";
  }

  function togglePassword(id, icon) {
    const input = document.getElementById(id);
    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    }
  }

  function switchToRegister() {
    document.getElementById("tabRegister").click();
  }

  //  FIX: H√†m x·ª≠ l√Ω thanh to√°n
  function proceedToCheckout() {
    const cart = getCart();

    if (cart.length === 0) {
      alert('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!');
      return;
    }

    if (!window.isLoggedIn) {
      document.getElementById("loginModal").style.display = "flex";
      return;
    }

    // X√ìA buyNowProduct ƒë·ªÉ trang checkout d√πng gi·ªè h√†ng hi·ªán t·∫°i
    localStorage.removeItem('buyNowProduct');

    window.location.href = '/checkout';
  }

  // ========== HEADER SEARCH FUNCTIONALITY ==========
  let headerSearchTimeout;

  async function headerSearch() {
    clearTimeout(headerSearchTimeout);

    headerSearchTimeout = setTimeout(async () => {
      const searchTerm = document.getElementById('headerSearchInput').value.trim().toLowerCase();
      const dropdown = document.getElementById('headerSearchDropdown');

      if (searchTerm === '') {
        dropdown.classList.remove('show');
        return;
      }

      try {
        // Call API to search products
        const response = await fetch(`/api/products/search?q=${encodeURIComponent(searchTerm)}`);
        const result = await response.json();

        if (result.success && result.products.length > 0) {
          dropdown.innerHTML = result.products.slice(0, 8).map(product => `
            <a href="/product/${product.ProductID}" class="header-search-result-item">
              <img src="${product.Image || '/assets/img/default-product.jpg'}" 
                   alt="${product.ProductName}" 
                   class="header-search-result-img">
              <div class="header-search-result-info">
                <div class="header-search-result-name">${product.ProductName}</div>
                <div class="header-search-result-price">
                  ${Number(product.Price).toLocaleString()}ƒë
                </div>
              </div>
            </a>
          `).join('');
          dropdown.classList.add('show');
        } else {
          dropdown.innerHTML = '<div class="header-search-no-results">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</div>';
          dropdown.classList.add('show');
        }
      } catch (error) {
        console.error('Search error:', error);
        dropdown.innerHTML = '<div class="header-search-no-results">L·ªói khi t√¨m ki·∫øm</div>';
        dropdown.classList.add('show');
      }
    }, 300); // Debounce 300ms
  }

  function showHeaderSearchDropdown() {
    const searchTerm = document.getElementById('headerSearchInput').value.trim();
    if (searchTerm !== '') {
      document.getElementById('headerSearchDropdown').classList.add('show');
    }
  }

  function hideHeaderSearchDropdown() {
    setTimeout(() => {
      document.getElementById('headerSearchDropdown').classList.remove('show');
    }, 200);
  }
</script>