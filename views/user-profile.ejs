<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng tin t√†i kho·∫£n - Fashion Shop</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/footer.css">
    <link rel="stylesheet" href="/assets/css/user-profile.css">
    <link rel="stylesheet" href="/assets/css/orders.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <%- include('partials/header') %>

        <div class="profile-container">
            <!-- SIDEBAR MENU -->
            <div class="profile-sidebar">
                <div class="user-welcome">
                    <h3>Xin ch√†o, <%= user.Username %>
                    </h3>
                </div>
                <ul class="profile-menu">
                    <li class="menu-item <%= tab === 'profile' ? 'active' : '' %>" data-tab="profile">
                        <a href="javascript:void(0)">
                            <i class="fas fa-user"></i>
                            Th√¥ng tin t√†i kho·∫£n
                        </a>
                    </li>
                    <li class="menu-item <%= tab === 'orders' ? 'active' : '' %>" data-tab="orders">
                        <a href="javascript:void(0)">
                            <i class="fas fa-shopping-bag"></i>
                            ƒê∆°n h√†ng c·ªßa b·∫°n
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="javascript:void(0)" onclick="logout()">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            ƒêƒÉng xu·∫•t
                        </a>
                    </li>
                </ul>
            </div>

            <!-- MAIN CONTENT - TH√îNG TIN T√ÄI KHO·∫¢N -->
            <div class="profile-content" id="profile-content">
                <h2 class="content-title">Th√¥ng tin t√†i kho·∫£n</h2>

                <form id="profileForm" class="profile-form">
                    <div class="form-group">
                        <label class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input type="text" class="form-input" value="<%= user.Username %>" disabled>
                        <small class="form-note">Kh√¥ng th·ªÉ thay ƒë·ªïi t√™n ƒëƒÉng nh·∫≠p</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" value="<%= user.Email %>" disabled>
                        <small class="form-note">Kh√¥ng th·ªÉ thay ƒë·ªïi email</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">H·ªç v√† t√™n *</label>
                        <input type="text" class="form-input" name="fullName" value="<%= user.FullName || '' %>"
                            placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n">
                        <small class="form-note">V√≠ d·ª•: Nguy·ªÖn VƒÉn A</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" class="form-input" name="phone" value="<%= user.Phone || '' %>"
                            placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" pattern="[0-9]{10,11}">
                        <small class="form-note">V√≠ d·ª•: 0912345678</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ƒê·ªãa ch·ªâ</label>
                        <textarea class="form-textarea" name="address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ c·ªßa b·∫°n"
                            rows="3"><%= user.Address || '' %></textarea>
                        <small class="form-note">V√≠ d·ª•: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM</small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-save">
                            <i class="fas fa-save"></i>
                            L∆∞u th√¥ng tin
                        </button>
                    </div>
                </form>
            </div>

            <!-- MAIN CONTENT - ƒê∆†N H√ÄNG -->
            <div class="profile-content orders-container" id="orders-content">
                <h2 class="content-title">ƒê∆°n h√†ng c·ªßa b·∫°n</h2>

                <div class="orders-container-inner">
                    <!-- TAB MENU -->
                    <div class="order-tabs">
                        <button class="order-tab active" data-tab="Pending">ƒêang ch·ªù x·ª≠ l√Ω</button>
                        <button class="order-tab" data-tab="Shipping">ƒêang giao</button>
                        <button class="order-tab" data-tab="Completed">ƒê√£ giao</button>
                        <button class="order-tab" data-tab="Cancelled">ƒê√£ h·ªßy</button>
                    </div>

                    <!-- TAB CONTENT -->
                    <div class="order-list">
                        <!-- ƒê∆°n h√†ng ƒëang ch·ªù x·ª≠ l√Ω -->
                        <div class="order-group active" id="Pending">
                            <% if (orders && orders.filter(o=> o.Status === 'Pending').length > 0) { %>
                                <% orders.filter(o=> o.Status === 'Pending').forEach(order => { %>
                                    <div class="order-item">
                                        <div class="order-header">
                                            <div>
                                                <div class="order-id">#<%= order.OrderID %>
                                                </div>
                                                <div class="order-date">Ng√†y ƒë·∫∑t: <%=
                                                        order.CreatedAt.toLocaleString('vi-VN') %>
                                                </div>
                                            </div>
                                            <div class="order-status status-pending">ƒêang ch·ªù x·ª≠ l√Ω</div>
                                        </div>

                                        <div class="order-products">
                                            <% if (order.Items && order.Items.length> 0) { %>
                                                <% order.Items.forEach(item=> { %>
                                                    <div class="product-item">
                                                        <div class="product-image">
                                                            <% if (item.Image) { %>
                                                                <img src="<%= item.Image %>"
                                                                    alt="<%= item.ProductName %>">
                                                                <% } else { %>
                                                                    <i class="fas fa-tshirt"></i>
                                                                    <% } %>
                                                        </div>
                                                        <div class="product-info">
                                                            <div class="product-name">
                                                                <%= item.ProductName %>
                                                            </div>
                                                            <div class="product-variant">
                                                                M√†u: <%= item.Color %> - Size: <%= item.Size %>
                                                            </div>
                                                            <div class="product-price">
                                                                <%= item.Price.toLocaleString('vi-VN') %>ƒë
                                                            </div>
                                                        </div>
                                                        <div class="product-quantity">x<%= item.Quantity %>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <p class="no-items">Kh√¥ng c√≥ s·∫£n ph·∫©m</p>
                                                            <% } %>
                                        </div>

                                        <div class="order-footer">
                                            <div class="order-total">T·ªïng ti·ªÅn: <%=
                                                    order.TotalAmount.toLocaleString('vi-VN') %>ƒë</div>
                                            <div class="order-actions">
                                                <button class="btn btn-outline"
                                                    onclick="cancelOrder(<%= order.OrderID %>)">H·ªßy ƒë∆°n</button>

                                            </div>
                                        </div>
                                    </div>
                                    <% }); %>
                                        <% } else { %>
                                            <div class="empty">
                                                <i class="fas fa-box-open"></i>
                                                <p>Ch∆∞a c√≥ ƒë∆°n h√†ng ƒëang ch·ªù x·ª≠ l√Ω</p>
                                            </div>
                                            <% } %>
                        </div>

                        <!-- ƒê∆°n h√†ng ƒëang giao -->
                        <div class="order-group" id="Shipping">
                            <% if (orders && orders.filter(o=> o.Status === 'Shipping').length > 0) { %>
                                <% orders.filter(o=> o.Status === 'Shipping').forEach(order => { %>
                                    <div class="order-item">
                                        <div class="order-header">
                                            <div>
                                                <div class="order-id">#<%= order.OrderID %>
                                                </div>
                                                <div class="order-date">Ng√†y ƒë·∫∑t: <%=
                                                        order.CreatedAt.toLocaleString('vi-VN') %>
                                                </div>
                                            </div>
                                            <div class="order-status status-pending">ƒêang giao</div>
                                        </div>

                                        <div class="order-products">
                                            <% if (order.Items && order.Items.length> 0) { %>
                                                <% order.Items.forEach(item=> { %>
                                                    <div class="product-item">
                                                        <div class="product-image">
                                                            <% if (item.Image) { %>
                                                                <img src="<%= item.Image %>"
                                                                    alt="<%= item.ProductName %>">
                                                                <% } else { %>
                                                                    <i class="fas fa-tshirt"></i>
                                                                    <% } %>
                                                        </div>
                                                        <div class="product-info">
                                                            <div class="product-name">
                                                                <%= item.ProductName %>
                                                            </div>
                                                            <div class="product-variant">
                                                                M√†u: <%= item.Color %> - Size: <%= item.Size %>
                                                            </div>
                                                            <div class="product-price">
                                                                <%= item.Price.toLocaleString('vi-VN') %>ƒë
                                                            </div>
                                                        </div>
                                                        <div class="product-quantity">x<%= item.Quantity %>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <p class="no-items">Kh√¥ng c√≥ s·∫£n ph·∫©m</p>
                                                            <% } %>
                                        </div>

                                        <div class="order-footer">
                                            <div class="order-total">T·ªïng ti·ªÅn: <%=
                                                    order.TotalAmount.toLocaleString('vi-VN') %>ƒë</div>
                                        </div>
                                    </div>
                        </div>
                        <% }); %>
                            <% } else { %>
                                <div class="empty">
                                    <i class="fas fa-shipping-fast"></i>
                                    <p>Ch∆∞a c√≥ ƒë∆°n h√†ng ƒëang giao</p>
                                </div>
                                <% } %>
                    </div>

                    <!-- ƒê∆°n h√†ng ƒë√£ giao -->
                    <div class="order-group" id="Completed">
                        <% if (orders && orders.filter(o=> o.Status === 'Completed').length > 0) { %>
                            <% orders.filter(o=> o.Status === 'Completed').forEach(order => { %>
                                <div class="order-item">
                                    <div class="order-header">
                                        <div>
                                            <div class="order-id">#<%= order.OrderID %>
                                            </div>
                                            <div class="order-date">Ng√†y ƒë·∫∑t: <%=
                                                    order.CreatedAt.toLocaleString('vi-VN') %>
                                            </div>
                                        </div>
                                        <div class="order-status status-active">ƒê√£ giao</div>
                                    </div>

                                    <div class="order-products">
                                        <% if (order.Items && order.Items.length> 0) { %>
                                            <% order.Items.forEach(item=> { %>
                                                <div class="product-item">
                                                    <div class="product-image">
                                                        <% if (item.Image) { %>
                                                            <img src="<%= item.Image %>" alt="<%= item.ProductName %>">
                                                            <% } else { %>
                                                                <i class="fas fa-tshirt"></i>
                                                                <% } %>
                                                    </div>
                                                    <div class="product-info">
                                                        <div class="product-name">
                                                            <%= item.ProductName %>
                                                        </div>
                                                        <div class="product-variant">
                                                            M√†u: <%= item.Color %> - Size: <%= item.Size %>
                                                        </div>
                                                        <div class="product-price">
                                                            <%= item.Price.toLocaleString('vi-VN') %>ƒë
                                                        </div>
                                                    </div>
                                                    <div class="product-quantity">x<%= item.Quantity %>
                                                    </div>
                                                </div>
                                                <% }); %>
                                                    <% } else { %>
                                                        <p class="no-items">Kh√¥ng c√≥ s·∫£n ph·∫©m</p>
                                                        <% } %>
                                    </div>

                                    <div class="order-footer">
                                        <div class="order-total">T·ªïng ti·ªÅn: <%=
                                                order.TotalAmount.toLocaleString('vi-VN') %>ƒë</div>
                                    </div>
                                </div>
                                <% }); %>
                                    <% } else { %>
                                        <div class="empty">
                                            <i class="fas fa-check-circle"></i>
                                            <p>Ch∆∞a c√≥ ƒë∆°n h√†ng ƒë√£ giao</p>
                                        </div>
                                        <% } %>
                    </div>

                    <!-- ƒê∆°n h√†ng ƒë√£ h·ªßy -->
                    <div class="order-group" id="Cancelled">
                        <% if (orders && orders.filter(o=> o.Status === 'Cancelled').length > 0) { %>
                            <% orders.filter(o=> o.Status === 'Cancelled').forEach(order => { %>
                                <div class="order-item">
                                    <div class="order-header">
                                        <div>
                                            <div class="order-id">#<%= order.OrderID %>
                                            </div>
                                            <div class="order-date">Ng√†y ƒë·∫∑t: <%=
                                                    order.CreatedAt.toLocaleString('vi-VN') %>
                                            </div>
                                            <div class="order-cancelled-by"
                                                style="color: #e74c3c; font-weight: 500; margin-top: 5px;">
                                                üö´ H·ªßy b·ªüi: B·∫°n
                                            </div>
                                        </div>
                                        <div class="order-status status-cancelled">ƒê√£ h·ªßy</div>
                                    </div>

                                    <div class="order-products">
                                        <% if (order.Items && order.Items.length> 0) { %>
                                            <% order.Items.forEach(item=> { %>
                                                <div class="product-item">
                                                    <div class="product-image">
                                                        <% if (item.Image) { %>
                                                            <img src="<%= item.Image %>" alt="<%= item.ProductName %>">
                                                            <% } else { %>
                                                                <i class="fas fa-tshirt"></i>
                                                                <% } %>
                                                    </div>
                                                    <div class="product-info">
                                                        <div class="product-name">
                                                            <%= item.ProductName %>
                                                        </div>
                                                        <div class="product-variant">
                                                            M√†u: <%= item.Color %> - Size: <%= item.Size %>
                                                        </div>
                                                        <div class="product-price">
                                                            <%= item.Price.toLocaleString('vi-VN') %>ƒë
                                                        </div>
                                                    </div>
                                                    <div class="product-quantity">x<%= item.Quantity %>
                                                    </div>
                                                </div>
                                                <% }); %>
                                                    <% } else { %>
                                                        <p class="no-items">Kh√¥ng c√≥ s·∫£n ph·∫©m</p>
                                                        <% } %>
                                    </div>

                                    <div class="order-footer">
                                        <div class="order-total">T·ªïng ti·ªÅn: <%=
                                                order.TotalAmount.toLocaleString('vi-VN') %>ƒë</div>
                                    </div>
                                </div>
                                <% }); %>
                                    <% } else { %>
                                        <div class="empty">
                                            <i class="fas fa-times-circle"></i>
                                            <p>Ch∆∞a c√≥ ƒë∆°n h√†ng ƒë√£ h·ªßy</p>
                                        </div>
                                        <% } %>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <%- include('partials/footer') %>

            <script>
                // L∆∞u gi√° tr·ªã ban ƒë·∫ßu ƒë·ªÉ reset form
                const initialValues = {
                    fullName: '<%= user.FullName || "" %>',
                    phone: '<%= user.Phone || "" %>',
                    address: '<%= user.Address || "" %>'
                };

                // H√ÄM ƒêƒÇNG XU·∫§T
                function logout() {
                    Swal.fire({
                        title: 'ƒêƒÉng xu·∫•t',
                        text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'ƒêƒÉng xu·∫•t',
                        cancelButtonText: 'H·ªßy'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            localStorage.removeItem("cart");
                            window.location.href = "/logout";
                        }
                    });
                }

                // X·ª≠ l√Ω submit form
                document.getElementById('profileForm').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const formData = new FormData(this);
                    const data = {
                        fullName: formData.get('fullName').trim(),
                        phone: formData.get('phone').trim(),
                        address: formData.get('address').trim()
                    };

                    const saveButton = this.querySelector('.btn-save');
                    saveButton.disabled = true;

                    try {
                        const response = await fetch('/update-profile', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
                        } else {
                            alert('L·ªói: ' + result.message);
                        }

                    } catch (error) {
                        console.error('L·ªói c·∫≠p nh·∫≠t:', error);
                        alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th√¥ng tin');
                    } finally {
                        saveButton.disabled = false;
                    }
                });

                // CHUY·ªÇN TAB TH√îNG TIN/ƒê∆†N H√ÄNG
                const menuItems = document.querySelectorAll('.profile-menu .menu-item[data-tab]');
                const profileContent = document.getElementById('profile-content');
                const ordersContent = document.getElementById('orders-content');

                menuItems.forEach(item => {
                    item.addEventListener('click', function () {
                        // C·∫≠p nh·∫≠t active menu
                        menuItems.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');

                        // Hi·ªÉn th·ªã n·ªôi dung t∆∞∆°ng ·ª©ng
                        const tab = this.dataset.tab;
                        if (tab === 'profile') {
                            profileContent.style.display = 'block';
                            ordersContent.style.display = 'none';
                        } else if (tab === 'orders') {
                            profileContent.style.display = 'none';
                            ordersContent.style.display = 'block';
                        }
                    });
                });

                // TAB SWITCH ƒê∆†N H√ÄNG
                const orderTabs = document.querySelectorAll(".order-tab");
                const orderGroups = document.querySelectorAll(".order-group");

                orderTabs.forEach(tab => {
                    tab.addEventListener("click", () => {
                        orderTabs.forEach(t => t.classList.remove("active"));
                        tab.classList.add("active");

                        const target = tab.dataset.tab;
                        orderGroups.forEach(g => {
                            g.classList.remove("active");
                            if (g.id === target) {
                                g.classList.add("active");
                            }
                        });
                    });
                });

                // C√°c h√†m x·ª≠ l√Ω ƒë∆°n h√†ng
                function cancelOrder(orderId) {
                    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?')) {
                        fetch(`/orders/cancel/${orderId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        })
                            .then(response => response.json())
                            .then(result => {
                                if (result.success) {
                                    alert('ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!');
                                    location.reload();
                                } else {
                                    alert('L·ªói: ' + result.message);
                                }
                            })
                            .catch(error => {
                                console.error('L·ªói h·ªßy ƒë∆°n h√†ng:', error);
                                alert('C√≥ l·ªói x·∫£y ra khi h·ªßy ƒë∆°n h√†ng');
                            });
                    }
                }

                function contactSupport() {
                    alert('Li√™n h·ªá h·ªó tr·ª£ kh√°ch h√†ng');
                }

                const activeTab = "<%= tab %>";

                // N·∫øu tab=orders ‚Üí t·ª± b·∫≠t tab ƒë∆°n h√†ng
                if (activeTab === "orders") {
                    document.querySelector('.menu-item[data-tab="profile"]').classList.remove("active");
                    document.getElementById("profile-content").style.display = "none";

                    document.querySelector('.menu-item[data-tab="orders"]').classList.add("active");
                    document.getElementById("orders-content").style.display = "block";
                }
            </script>
</body>

</html>