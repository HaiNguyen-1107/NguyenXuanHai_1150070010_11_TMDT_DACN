<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= product.ProductName %> | Fashion Shop
  </title>
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/home.css">
  <link rel="stylesheet" href="/assets/css/footer.css">
  <link rel="stylesheet" href="/assets/css/productdetail.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
  <%- include('partials/header') %>

    <!-- MAIN PRODUCT SECTION -->
    <div class="product-detail-container">
      <!-- IMAGE GALLERY -->
      <div class="gallery">
        <div class="thumbnail-list">
          <% productImages.forEach((img, index)=> { %>
            <img src="<%= img.ImageURL %>" class="thumb-img" onclick="changeMainImage('<%= img.ImageURL %>')">
            <% }) %>
        </div>

        <div class="main-image">
          <img src="<%= productImages[0]?.ImageURL %>" id="mainPreview">
        </div>
      </div>

      <!-- PRODUCT INFO -->
      <div class="product-info">
        <h2 class="product-name">
          <%= product.ProductName %>
        </h2>
        <p class="brand">Th∆∞∆°ng hi·ªáu: <span>Kh√¥ng x√°c ƒë·ªãnh</span></p>
        <p class="price-new">
          <%= product.Price.toLocaleString() %>‚Ç´
        </p>

        <div class="options">
          <!-- COLOR OPTIONS -->
          <% const uniqueColors=[...new Set(variants.map(v=> v.Color))];
            const firstColor = uniqueColors[0];
            %>
            <div class="color-box">
              <p>M√†u s·∫Øc:</p>
              <% uniqueColors.forEach((color, index)=> { %>
                <button class="color-option <%= index === 0 ? 'active' : '' %>" data-color="<%= color %>">
                  <%= color %>
                </button>
                <% }) %>
            </div>

            <!-- SIZE OPTIONS -->
            <% const sizesForFirstColor=variants.filter(v=> v.Color === firstColor).map(v => v.Size);
              const firstSize = sizesForFirstColor[0];
              const defaultVariant = variants.find(v => v.Color === firstColor && v.Size === firstSize);
              %>
              <div class="size-box">
                <p>Size:</p>
                <% sizesForFirstColor.forEach((size, index)=> { %>
                  <button class="size-option <%= index === 0 ? 'active' : '' %>" data-size="<%= size %>">
                    <%= size %>
                  </button>
                  <% }) %>
              </div>

              <!-- QUANTITY -->
              <div class="quantity-box">
                <p>S·ªë l∆∞·ª£ng:</p>
                <button class="qty-btn" id="decreaseQty">-</button>
                <input type="text" value="1" class="qty-input" id="quantityInput">
                <button class="qty-btn" id="increaseQty">+</button>
              </div>
        </div>

        <!-- STOCK & ACTIONS -->
        <div class="stock-status" id="stockStatus">
          <% if (defaultVariant && defaultVariant.Stock> 0) { %>
            <p class="in-stock">‚úì S·ªë l∆∞·ª£ng h√†ng c√≤n: <%= defaultVariant.Stock %> s·∫£n ph·∫©m</p>
            <% } else { %>
              <p class="out-stock">‚úó H·∫øt h√†ng</p>
              <% } %>
        </div>

        <div class="action-btns">
          <button class="buy-now" onclick="checkLoginBeforeBuyNow()">MUA NGAY</button>
          <button class="add-cart" onclick="checkLoginBeforeAddToCart()">TH√äM V√ÄO GI·ªé</button>
        </div>
      </div> <!-- ƒê√ìNG ƒê√öNG V·ªä TR√ç product-info -->
    </div>

    <!-- TABS SECTION -->
    <div class="detail-tabs">
      <button class="tab active" data-tab="description">Th√¥ng tin s·∫£n ph·∫©m</button>
      <button class="tab" data-tab="warranty">Ch√≠nh s√°ch b·∫£o h√†nh</button>
      <button class="tab" data-tab="reviews">ƒê√°nh gi√°</button>
    </div>

    <div class="tab-content-container">
      <div class="tab-content active" id="description-content">
        <p class="description">
          <%= description %>
        </p>
      </div>

      <div class="tab-content" id="warranty-content">
        <h3>Ch√≠nh s√°ch b·∫£o h√†nh chi ti·∫øt</h3>
        <p>B·∫£o h√†nh 1 ƒë·ªïi 1 trong v√≤ng 7 ng√†y n·∫øu c√≥ l·ªói t·ª´ nh√† s·∫£n xu·∫•t. Ho√†n ti·ªÅn 100% n·∫øu s·∫£n ph·∫©m kh√¥ng ƒë√∫ng m√¥ t·∫£.
        </p>
      </div>

      <div class="tab-content" id="reviews-content">
        <div class="reviews-header">
          <h3>ƒê√°nh gi√° s·∫£n ph·∫©m</h3>
          <button class="write-review-btn" id="openReviewSidebar">
            <i class="fas fa-pen"></i> Vi·∫øt ƒë√°nh gi√°
          </button>
        </div>
        <div class="reviews-list" style="display: none;"></div>
      </div>
    </div>

    <!-- REVIEW SIDEBAR -->
    <div class="review-sidebar-overlay" id="reviewOverlay">
      <div class="review-sidebar">
        <div class="review-sidebar-header">
          <h3>Vi·∫øt ƒë√°nh gi√°</h3>
          <button class="close-sidebar" id="closeReviewSidebar"><i class="fas fa-times"></i></button>
        </div>

        <div class="review-sidebar-content">
          <div class="review-product-info">
            <div>
              <h4>
                <%= product.ProductName %>
              </h4>
            </div>
          </div>

          <form class="review-form" id="reviewForm">
            <div class="rating-section">
              <label>ƒê√°nh gi√° c·ªßa b·∫°n *</label>
              <div class="star-rating">
                <% for(let i=1; i<=5; i++) { %>
                  <span class="star" data-rating="<%= i %>">‚òÖ</span>
                  <% } %>
              </div>
              <input type="hidden" id="ratingValue" name="rating" required>
            </div>

            <div class="form-group">
              <label for="reviewContent">N·ªôi dung ƒë√°nh gi√° *</label>
              <textarea id="reviewContent" name="content" rows="5" placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n..."
                required></textarea>
            </div>

            <div class="form-group">
              <label for="reviewerName">T√™n c·ªßa b·∫°n *</label>
              <input type="text" id="reviewerName" name="name" required>
            </div>

            <div class="form-group">
              <label for="reviewerEmail">Email *</label>
              <input type="email" id="reviewerEmail" name="email" required>
            </div>

            <button type="submit" class="submit-review-btn">G·ª≠i ƒë√°nh gi√°</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Hidden variant data for JavaScript -->
    <script type="application/json" id="variantData">
      <%- JSON.stringify(variants) %>
    </script>

    <script>
      // H√†m ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi TH√äM V√ÄO GI·ªé
      function checkLoginBeforeAddToCart() {
        if (!window.isLoggedIn) {
          document.getElementById("loginModal").style.display = "flex";
      } else {
      // L·∫•y d·ªØ li·ªáu variants t·ª´ JSON
      const variantsData = JSON.parse(document.getElementById("variantData").textContent);

      // L·∫•y m√†u v√† size ƒëang ƒë∆∞·ª£c ch·ªçn
      const currentColor = document.querySelector(".color-option.active")?.dataset.color || null;
      const currentSize = document.querySelector(".size-option.active")?.dataset.size || null;

      console.log('üõí [DEBUG] ===== B·∫ÆT ƒê·∫¶U TH√äM V√ÄO GI·ªé =====');
      console.log('üõí [DEBUG] Selected from UI:');
      console.log(' - currentColor:', currentColor);
      console.log(' - currentSize:', currentSize);
      console.log('üì¶ [DEBUG] All variants from database:');
      console.log(variantsData);

      // T√¨m variant tr·ª±c ti·∫øp v·ªõi chu·∫©n h√≥a kho·∫£ng tr·∫Øng
      const matchedVariant = variantsData.find(v => {
      // Chu·∫©n h√≥a: lowercase, b·ªè d·∫•u, trim kho·∫£ng tr·∫Øng
      const normalizeColor = (str) => str?.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim() || '';
      const normalizeSize = (str) => str?.toUpperCase().trim() || '';

      const colorMatch = normalizeColor(v.Color) === normalizeColor(currentColor);
      const sizeMatch = normalizeSize(v.Size) === normalizeSize(currentSize);

      console.log(`‚û°Ô∏è [DEBUG] ƒêang ki·ªÉm tra VariantID=${v.VariantID}:`);
      console.log(` DB Color: "${v.Color}" (normalized: "${normalizeColor(v.Color)}")`);
      console.log(` UI Color: "${currentColor}" (normalized: "${normalizeColor(currentColor)}")`);
      console.log(` DB Size: "${v.Size}" (normalized: "${normalizeSize(v.Size)}")`);
      console.log(` UI Size: "${currentSize}" (normalized: "${normalizeSize(currentSize)}")`);
      console.log(` => colorMatch=${colorMatch}, sizeMatch=${sizeMatch}`);
      console.log('---');
      return colorMatch && sizeMatch;
      });

      const variantId = matchedVariant ? matchedVariant.VariantID : null;
      console.log('‚úÖ [DEBUG] K·∫øt qu·∫£ cu·ªëi c√πng:');
      if (matchedVariant) {
      console.log(' ‚úÖ T√åM TH·∫§Y VARIANT!');
      console.log(' - VariantID:', matchedVariant.VariantID);
      console.log(' - Color:', matchedVariant.Color);
      console.log(' - Size:', matchedVariant.Size);
      console.log(' - Stock:', matchedVariant.Stock);
      } else {
      console.log(' ‚ùå KH√îNG T√åM TH·∫§Y VARIANT N√ÄO KH·ª¢P!');
      console.log(' => variantId s·∫Ω l√†: null');
      }
      console.log('üõí [DEBUG] ===== K·∫æT TH√öC =====');

      const product = {
      id: <%= product.ProductID %>,
        name: '<%= product.ProductName.replace(/'/g, "\\'" ) %>',
          price: <%= product.Price %>,
            image: '<%= productImages[0]?.ImageURL %>',
              color: currentColor,
              size: currentSize,
              variantId: variantId,
              quantity: parseInt(document.getElementById('quantityInput').value)
              };

              console.log('üì¶ [DEBUG] Product object g·ª≠i ƒëi:');
              console.log(product);
              console.log('---');

              window.addToCart(product);
              }
              }

              function buyNowCheckout() {
              // c·∫≠p nh·∫≠t l·∫°i m√†u & size sau khi user ch·ªçn
              selectedColor = document.querySelector(".color-option.active")?.dataset.color || null;
              selectedSize = document.querySelector(".size-option.active")?.dataset.size || null;
              const variantId = getSelectedVariantId();

              const quantity = parseInt(document.getElementById('quantityInput').value);

              // Ki·ªÉm tra stock tr∆∞·ªõc khi checkout
              const variant = variants.find(v => v.Color === selectedColor && v.Size === selectedSize);
              if (!variant || variant.Stock <= 0) { alert('S·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng!'); return; } if (quantity>
                variant.Stock) {
                alert(`Ch·ªâ c√≤n ${variant.Stock} s·∫£n ph·∫©m trong kho!`);
                return;
                }

                const name = "<%= product.ProductName %>";
                  const price = <%= product.Price %>;
                    const image = "<%= productImages[0]?.ImageURL %>";
                      const productId = <%= product.ProductID %>;

                        const product = {
                        id: productId,
                        name,
                        price,
                        image,
                        color: selectedColor,
                        size: selectedSize,
                        variantId: variantId,
                        quantity
                        };

                        console.log("BUY NOW PRODUCT:", product);

                        // L∆∞u v√†o localStorage
                        localStorage.setItem("buyNowProduct", JSON.stringify(product));

                        // ƒêi·ªÅu h∆∞·ªõng sang checkout
                        window.location.href = "/checkout";
                        }

                        function addCurrentProductToCart() {
                        // C·∫≠p nh·∫≠t l·∫°i m√†u v√† size t·ª´ UI
                        selectedColor = document.querySelector(".color-option.active")?.dataset.color || null;
                        selectedSize = document.querySelector(".size-option.active")?.dataset.size || null;

                        console.log('üõí [ADD TO CART] selectedColor:', selectedColor, 'selectedSize:', selectedSize);

                        // T√¨m variant tr·ª±c ti·∫øp t·∫°i ƒë√¢y thay v√¨ g·ªçi h√†m
                        // Chu·∫©n h√≥a chu·ªói ƒë·ªÉ so s√°nh
                        const normalizeColor = (str) => str?.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,
                        '').trim() || '';
                        const normalizeSize = (str) => str?.toUpperCase().trim() || '';

                        const matchedVariant = variants.find(v => {
                        const colorMatch = normalizeColor(v.Color) === normalizeColor(selectedColor);
                        const sizeMatch = normalizeSize(v.Size) === normalizeSize(selectedSize);
                        return colorMatch && sizeMatch;
                        });

                        const variantId = matchedVariant ? matchedVariant.VariantID : null;
                        console.log('üéØ [ADD TO CART] Matched variant:', matchedVariant);
                        console.log('üéØ [ADD TO CART] variantId:', variantId);

                        const product = {
                        id: <%= product.ProductID %>,
                          name: '<%= product.ProductName %>',
                            price: <%= product.Price %>,
                              image: '<%= productImages[0]?.ImageURL %>',
                                color: selectedColor,
                                size: selectedSize,
                                variantId: variantId,
                                quantity: parseInt(document.getElementById('quantityInput').value)
                                };

                                console.log('üì¶ [ADD TO CART] Product to add:', product);

                                window.addToCart(product);
                                }



                                // Global variables - KH·ªöI T·∫†O SAU KHI DOM LOAD XONG
                                let variants;
                                let selectedColor;
                                let selectedSize;

                                function getSelectedVariantId() {
                                console.log('üîç Searching variant for:', { selectedColor, selectedSize });
                                console.log('üì¶ Available variants:', variants);

                                // Chu·∫©n h√≥a chu·ªói ƒë·ªÉ so s√°nh
                                const normalizeColor = (str) =>
                                str?.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim() || '';
                                const normalizeSize = (str) => str?.toUpperCase().trim() || '';

                                const v = variants.find(v => {
                                const colorMatch = normalizeColor(v.Color) === normalizeColor(selectedColor);
                                const sizeMatch = normalizeSize(v.Size) === normalizeSize(selectedSize);

                                console.log(`Checking variant ${v.VariantID}:`, {
                                dbColor: v.Color,
                                selectedColor,
                                colorMatch,
                                dbSize: v.Size,
                                selectedSize,
                                sizeMatch
                                });

                                return colorMatch && sizeMatch;
                                });

                                console.log('‚úÖ Found variant:', v);
                                return v ? v.VariantID : null;
                                }


                                // Stock management
                                function updateStock() {
                                const variant = variants.find(v => v.Color === selectedColor && v.Size ===
                                selectedSize);
                                const stockStatus = document.getElementById("stockStatus");
                                const quantityInput = document.getElementById('quantityInput');
                                const currentQty = parseInt(quantityInput.value) || 1;
                                const buyNowBtn = document.querySelector('.buy-now');
                                const addCartBtn = document.querySelector('.add-cart');

                                if (variant && variant.Stock > 0) {
                                if (currentQty > variant.Stock) {
                                stockStatus.innerHTML = `<p class="out-stock">‚úó H·∫øt h√†ng (Ch·ªâ c√≤n ${variant.Stock} s·∫£n
                                  ph·∫©m)</p>`;
                                buyNowBtn.disabled = true;
                                addCartBtn.disabled = true;
                                buyNowBtn.style.opacity = '0.5';
                                buyNowBtn.style.cursor = 'not-allowed';
                                addCartBtn.style.opacity = '0.5';
                                addCartBtn.style.cursor = 'not-allowed';
                                } else {
                                stockStatus.innerHTML = `<p class="in-stock">‚úì S·ªë l∆∞·ª£ng h√†ng c√≤n: ${variant.Stock} s·∫£n
                                  ph·∫©m</p>`;
                                buyNowBtn.disabled = false;
                                addCartBtn.disabled = false;
                                buyNowBtn.style.opacity = '1';
                                buyNowBtn.style.cursor = 'pointer';
                                addCartBtn.style.opacity = '1';
                                addCartBtn.style.cursor = 'pointer';
                                }
                                } else {
                                stockStatus.innerHTML = `<p class="out-stock">‚úó H·∫øt h√†ng</p>`;
                                buyNowBtn.disabled = true;
                                addCartBtn.disabled = true;
                                buyNowBtn.style.opacity = '0.5';
                                buyNowBtn.style.cursor = 'not-allowed';
                                addCartBtn.style.opacity = '0.5';
                                addCartBtn.style.cursor = 'not-allowed';
                                }
                                }

                                // Size options update
                                function updateSizes() {
                                const sizeBox = document.querySelector('.size-box');
                                const sizesForColor = variants.filter(v => v.Color === selectedColor).map(v => v.Size);

                                sizeBox.innerHTML = '<p>Size:</p>';
                                sizesForColor.forEach((size, index) => {
                                const button = document.createElement('button');
                                button.className = `size-option ${index === 0 ? 'active' : ''}`;
                                button.dataset.size = size;
                                button.textContent = size;
                                button.addEventListener('click', handleSizeSelect);
                                sizeBox.appendChild(button);
                                });

                                selectedSize = sizesForColor[0];
                                updateStock();
                                }

                                // Event handlers
                                function handleColorSelect(e) {
                                document.querySelectorAll('.color-option').forEach(btn =>
                                btn.classList.remove('active'));
                                e.target.classList.add('active');
                                selectedColor = e.target.dataset.color;
                                updateSizes();
                                }

                                function handleSizeSelect(e) {
                                document.querySelectorAll('.size-option').forEach(btn =>
                                btn.classList.remove('active'));
                                e.target.classList.add('active');
                                selectedSize = e.target.dataset.size;
                                updateStock();
                                }

                                function handleTabSwitch(e) {
                                const tabName = e.target.dataset.tab;
                                document.querySelectorAll('.detail-tabs .tab, .tab-content').forEach(el =>
                                el.classList.remove('active'));
                                e.target.classList.add('active');
                                document.getElementById(`${tabName}-content`).classList.add('active');
                                }

                                // Review sidebar functions
                                function toggleReviewSidebar(show) {
                                const reviewOverlay = document.getElementById('reviewOverlay');
                                reviewOverlay.classList.toggle('active', show);
                                document.body.style.overflow = show ? 'hidden' : '';
                                }

                                function setupStarRating() {
                                const stars = document.querySelectorAll('.star-rating .star');
                                const ratingValue = document.getElementById('ratingValue');

                                stars.forEach(star => {
                                star.addEventListener('click', () => {
                                const rating = parseInt(star.getAttribute('data-rating'));
                                ratingValue.value = rating;
                                stars.forEach((s, i) => s.classList.toggle('active', i < rating));
                                });
                              });
                            }

                            // Event listeners
                            document.addEventListener('DOMContentLoaded', () => {
                              // ‚úÖ KH·ªúI T·∫†O BI·∫æN SAU KHI DOM LOAD XONG
                              variants = JSON.parse(document.getElementById("variantData").textContent);
                                  selectedColor = document.querySelector('.color-option.active')?.dataset.color;
                                  selectedSize = document.querySelector('.size-option.active')?.dataset.size;

                                  console.log('üöÄ [INIT] Initial selection:', { selectedColor, selectedSize });
                                  console.log('üì¶ [INIT] All variants:', variants);

                                  // Product options
                                  document.querySelectorAll('.color-option').forEach(btn =>
                                  btn.addEventListener('click', handleColorSelect));
                                  document.querySelectorAll('.size-option').forEach(btn => btn.addEventListener('click',
                                  handleSizeSelect));
                                  document.querySelectorAll('.detail-tabs .tab').forEach(btn =>
                                  btn.addEventListener('click', handleTabSwitch));

                                  // Quantity controls
                                  document.getElementById('increaseQty').addEventListener('click', () => {
                                  const input = document.getElementById('quantityInput');
                                  const variant = variants.find(v => v.Color === selectedColor && v.Size ===
                                  selectedSize);
                                  const currentQty = parseInt(input.value) || 0;

                                  if (variant && currentQty < variant.Stock) { input.value=currentQty + 1;
                                    updateStock(); } else { alert(`Ch·ªâ c√≤n ${variant ? variant.Stock : 0} s·∫£n ph·∫©m trong
                                    kho!`);
                                  }
                                });

                                document.getElementById('decreaseQty').addEventListener('click', () =>
                                    {
                                    const input = document.getElementById('quantityInput');
                                    if (parseInt(input.value) > 1) {
                                    input.value = parseInt(input.value) - 1;
                                    updateStock();
                                    }
                                    });

                                    document.getElementById('quantityInput').addEventListener('input', () => {
                                    const input = document.getElementById('quantityInput');
                                    let value = parseInt(input.value) || 1;

                                    if (value < 1) value=1; input.value=value; updateStock(); }); // Image gallery
                                      document.querySelectorAll(".thumb-img").forEach(img=> {
                                      img.addEventListener("click", () => {
                                      document.getElementById("mainPreview").src = img.src;
                                      });
                                      });

                                      // Review system
                                      document.getElementById('openReviewSidebar').addEventListener('click', () =>
                                      toggleReviewSidebar(true));
                                      document.getElementById('closeReviewSidebar').addEventListener('click', () =>
                                      toggleReviewSidebar(false));
                                      document.getElementById('reviewOverlay').addEventListener('click', (e) => {
                                      if (e.target === document.getElementById('reviewOverlay'))
                                      toggleReviewSidebar(false);
                                      });

                                      setupStarRating();

                                      document.getElementById('reviewForm').addEventListener('submit', (e) => {
                                      e.preventDefault();
                                      if (!document.getElementById('ratingValue').value) {
                                      alert('Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°!');
                                      return;
                                      }
                                      alert('C·∫£m ∆°n b·∫°n ƒë√£ g·ª≠i ƒë√°nh gi√°!');
                                      toggleReviewSidebar(false);
                                      e.target.reset();
                                      document.querySelectorAll('.star').forEach(star =>
                                      star.classList.remove('active'));
                                      });

                                            // Initial stock check
                                            updateStock();
                                            });

                                            function changeMainImage(url) {
                                            document.getElementById("mainPreview").src = url;
                                            }

                                            // H√†m ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi MUA NGAY
                                            function checkLoginBeforeBuyNow() {
                                            if (!window.isLoggedIn) {
                                            // Hi·ªán form ƒëƒÉng nh·∫≠p
                                            document.getElementById("loginModal").style.display = "flex";
                                            // KH√îNG l∆∞u l·∫°i h√†nh ƒë·ªông, ƒë·ªÉ ng∆∞·ªùi d√πng t·ª± l√†m l·∫°i sau khi login
                                            } else {
                                            // ƒê√£ ƒëƒÉng nh·∫≠p, chuy·ªÉn ƒë·∫øn thanh to√°n
                                            buyNowCheckout();
                                            }
                                            }
                                  </script>
                                  
                                  <%- include('partials/footer') %>
</body>

</html>